name: Deploy to production

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main

jobs:
  build-docker-image-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SUBMODULE_TOKEN }}
          submodules: true

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build JAR
        run: ./gradlew bootJar -Dspring.profiles.active=prod

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          file: ./Dockerfile
          tags: ${{ secrets.DOCKER_HUB_REPOSITORY }}:prod

  deployment:
    runs-on: ubuntu-latest
    needs: [ build-docker-image-and-push ]
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            cd api/bin/
            
            # í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            sudo docker compose pull
            api1_running=$(sudo docker ps --filter "name=petqua-api1" --format "{{.Names}}" | grep -w "petqua-api1" | wc -l)
            if [ $api1_running -eq 1 ]; then
            # petqua-api1ì´ ì‹¤í–‰ì¤‘ì´ë©´, petqua-api2 ì‹¤í–‰
            sudo docker compose up -d petqua-api2
            
            # port ì„¤ì •
            port=8081
            blue_container="petqua-api1"
            echo -e "â–¶ï¸ petqua-api2ì— ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤"
            
            else
            # petqua-api2ê°€ ì‹¤í–‰ì¤‘ì´ê±°ë‚˜ ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ë‹¤ë©´, petqua-api1 ì‹¤í–‰
            sudo docker compose up -d petqua-api1
            
            # port ì„¤ì •
            port=8080
            blue_container="petqua-api2"
            echo -e "â–¶ï¸ petqua-api1ì— ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤"
            fi
            
            # í—¬ìŠ¤ ì²´í¬ - ìµœëŒ€ 10ë²ˆ ì¬ì‹œë„
            for retry in {1..10}
            do
            # spring boot actuatorë¡œ ì§€ì •í•œ url, ~/management/health-checkì— ìš”ì²­ì„ ë³´ë‚´ í—¬ìŠ¤ ì²´í¬ ê²€ì‚¬
            response=$(curl -s http://127.0.0.1:$port/management/health-check)
            isHealth=$(echo ${response} | grep 'UP' | wc -l)
            if [ $isHealth -eq 1 ]
            then
            break
            else
            echo -e "âš ï¸ í—¬ìŠ¤ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. 10ì´ˆ ìŠ¬ë¦½ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤."
            sleep 10
            fi
            
            if [ $isHealth - eq 0]
            then
            echo -e "â—ï¸ ì„œë²„ í—¬ìŠ¤ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 0
            else
            echo -e "âœ… ì„œë²„ í—¬ìŠ¤ì²´í¬ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. Nginxë¥¼ ë¦¬ë¡œë“œí•©ë‹ˆë‹¤."
            fi
            
            # Nginx ì„¤ì • ì—…ë°ì´íŠ¸
            echo "set \$backend_port $port;" | sudo tee /etc/nginx/conf.d/port.inc
            sudo nginx -s reload
            
            # êµ¬ë²„ì „ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨
            docker stop $blue_container
            
            echo -e "ğŸš€ ì„œë²„ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
